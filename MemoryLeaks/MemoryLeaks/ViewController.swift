//
//  ViewController.swift
//  MemoryLeaks
//
//  Created by Amir Zigangaraev on 12.10.2020.
//

import UIKit

class ViewController: UIViewController {

    override func viewDidLoad() {
        super.viewDidLoad()
        
        let stackView = UIStackView()
        view.addSubview(stackView)
        stackView.translatesAutoresizingMaskIntoConstraints = false
        stackView.distribution = .fillEqually
        
        NSLayoutConstraint.activate([
            stackView.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor),
            stackView.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor),
            stackView.leadingAnchor.constraint(equalTo: view.safeAreaLayoutGuide.leadingAnchor),
            stackView.trailingAnchor.constraint(equalTo: view.safeAreaLayoutGuide.trailingAnchor),
        ])
        
        stackView.frame = CGRect(x: 0, y: 0, width: 300, height: 300)
        stackView.axis = .vertical
        self.stackView = stackView
        
        for _ in 1...5 {
            stackView.addArrangedSubview(generateView())
        }
        
        let addNewButton = UIButton(type: .system)
        addNewButton.addTarget(self, action: #selector(addNew), for: .touchDown)
        addNewButton.setTitle("Add new", for: .normal)
        stackView.addArrangedSubview(addNewButton)
    }
    
    private var stackView: UIStackView?
    
    func generateView() -> UIView {
        let deletableView = DeletableView()
        
        // В данном случае будут утечки памяти, так как deletableView держит ссылку на саму себя в данном Closure
        // deletableView.deleteAction = {
        //     deletableView.removeFromSuperview()
        // }
        
        // В данном утечки памяти не будет
        deletableView.deleteAction = { [weak deletableView] in
            deletableView?.removeFromSuperview()
        }
        return deletableView
    }

    @objc func addNew() {
        stackView?.insertArrangedSubview(generateView(), at: 0)
    }
}

class DeletableView: UIView {
    var deleteAction: (() -> Void)?
    
    let button: UIButton = {
        let button = UIButton(type: .system)
        button.setTitle("Delete", for: .normal)
        button.setTitleColor(.red, for: .normal)
        return button
    }()
    
    let data = Data(base64Encoded: "123123123123123123123123123123123123123129387102938712938612376512873512874651287453987468961349876876248623487126301298312093712098371290371209387129038712093871209387123987120938712903871209387120938712937120938712093871209387129038712093871209387120938712908371209371209387190283719287301928731902783091273190273819028731290873910827310928371231231231231231231231231231231231231231293871029387129386123765128735128746512874539874689613498768762486234871263012983120937120983712903712093871290387120938712093871239871209387129038712093871209387129371209387120938712093871290387120938712093871209387129083712093712093871902837192873019287319027830912731902738190287312908739108273109283712312312312312312312312312312312312312312938710293871293861237651287351287465128745398746896134987687624862348712630129831209371209837129037120938712903871209387120938712398712093871290387120938712093871293712093871209387120938712903871209387120938712093871290837120937120938719028371928730192873190278309127319027381902873129087391082731092837123123123123123123123123123123123123123129387102938712938612376512873512874651287453987468961349876876248623487126301298312093712098371290371209387129038712093871209387123987120938712903871209387120938712937120938712093871209387129038712093871209387120938712908371209371209387190283719287301928731902783091273190273819028731290873910827310928371231231231231231231231231231231231231231293871029387129386123765128735128746512874539874689613498768762486234871263012983120937120983712903712093871290387120938712093871239871209387129038712093871209387129371209387120938712093871290387120938712093871209387129083712093712093871902837192873019287319027830912731902738190287312908739108273109283712312312312312312312312312312312312312312938710293871293861237651287351287465128745398746896134987687624862348712630129831209371209837129037120938712903871209387120938712398712093871290387120938712093871293712093871209387120938712903871209387120938712093871290837120937120938719028371928730192873190278309127319027381902873129087391082731092837123123123123123123123123123123123123123129387102938712938612376512873512874651287453987468961349876876248623487126301298312093712098371290371209387129038712093871209387123987120938712903871209387120938712937120938712093871209387129038712093871209387120938712908371209371209387190283719287301928731902783091273190273819028731290873910827310928371231231231231231231231231231231231231231293871029387129386123765128735128746512874539874689613498768762486234871263012983120937120983712903712093871290387120938712093871239871209387129038712093871209387129371209387120938712093871290387120938712093871209387129083712093712093871902837192873019287319027830912731902738190287312908739108273109283712312312312312312312312312312312312312312938710293871293861237651287351287465128745398746896134987687624862348712630129831209371209837129037120938712903871209387120938712398712093871290387120938712093871293712093871209387120938712903871209387120938712093871290837120937120938719028371928730192873190278309127319027381902873129087391082731092837123123123123123123123123123123123123123129387102938712938612376512873512874651287453987468961349876876248623487126301298312093712098371290371209387129038712093871209387123987120938712903871209387120938712937120938712093871209387129038712093871209387120938712908371209371209387190283719287301928731902783091273190273819028731290873910827310928371231231231231231231231231231231231231231293871029387129386123765128735128746512874539874689613498768762486234871263012983120937120983712903712093871290387120938712093871239871209387129038712093871209387129371209387120938712093871290387120938712093871209387129083712093712093871902837192873019287319027830912731902738190287312908739108273109283712312312312312312312312312312312312312312938710293871293861237651287351287465128745398746896134987687624862348712630129831209371209837129037120938712903871209387120938712398712093871290387120938712093871293712093871209387120938712903871209387120938712093871290837120937120938719028371928730192873190278309127319027381902873129087391082731092837123123123123123123123123123123123123123129387102938712938612376512873512874651287453987468961349876876248623487126301298312093712098371290371209387129038712093871209387123987120938712903871209387120938712937120938712093871209387129038712093871209387120938712908371209371209387190283719287301928731902783091273190273819028731290873910827310928371231231231231231231231231231231231231231293871029387129386123765128735128746512874539874689613498768762486234871263012983120937120983712903712093871290387120938712093871239871209387129038712093871209387129371209387120938712093871290387120938712093871209387129083712093712093871902837192873019287319027830912731902738190287312908739108273109283712312312312312312312312312312312312312312938710293871293861237651287351287465128745398746896134987687624862348712630129831209371209837129037120938712903871209387120938712398712093871290387120938712093871293712093871209387120938712903871209387120938712093871290837120937120938719028371928730192873190278309127319027381902873129087391082731092837123123123123123123123123123123123123123129387102938712938612376512873512874651287453987468961349876876248623487126301298312093712098371290371209387129038712093871209387123987120938712903871209387120938712937120938712093871209387129038712093871209387120938712908371209371209387190283719287301928731902783091273190273819028731290873910827310928371231231231231231231231231231231231231231293871029387129386123765128735128746512874539874689613498768762486234871263012983120937120983712903712093871290387120938712093871239871209387129038712093871209387129371209387120938712093871290387120938712093871209387129083712093712093871902837192873019287319027830912731902738190287312908739108273109283712312312312312312312312312312312312312312938710293871293861237651287351287465128745398746896134987687624862348712630129831209371209837129037120938712903871209387120938712398712093871290387120938712093871293712093871209387120938712903871209387120938712093871290837120937120938719028371928730192873190278309127319027381902873129087391082731092837")

    let imageView = UIImageView(image: UIImage(named: "lion")!)
    
    override func layoutSubviews() {
        super.layoutSubviews()
        
        imageView.frame = self.bounds
        button.frame = self.bounds
    }
    
    override init(frame: CGRect) {
        super.init(frame: frame)
        
        addSubview(imageView)
        addSubview(button)
        button.addTarget(self, action: #selector(buttonTap), for: .touchDown)
    }
    
    @objc private func buttonTap() {
        deleteAction?()
    }
    
    required init?(coder: NSCoder) {
        nil
    }
    
    deinit {
        print("Deinit")
    }
}

